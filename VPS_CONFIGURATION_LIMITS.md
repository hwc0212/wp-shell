# VPS配置要求限制功能说明

## 更新时间
2026-01-08

## 功能概述

为了防止用户在小VPS上搭建过多WordPress网站导致VPS崩溃，我们为两个脚本添加了智能VPS配置检查和限制功能。

## wp-vps-manager.sh (多站点版) 新增功能

### VPS配置等级划分

| 配置等级 | 内存要求 | CPU要求 | 最大站点数 | 推荐站点数 |
|----------|----------|---------|------------|------------|
| 高配置   | ≥8GB     | ≥4核    | 10个       | 8个        |
| 中等配置 | ≥4GB     | ≥2核    | 6个        | 4个        |
| 标准配置 | ≥2GB     | ≥2核    | 3个        | 2个        |
| 基础配置 | ≥1GB     | ≥1核    | 2个        | 1个        |
| 低配置   | ≥512MB   | ≥1核    | 1个        | 1个        |

### 智能限制功能

1. **自动检测VPS配置**
   - 检测内存、CPU核心数、可用磁盘空间
   - 根据配置自动分类VPS等级

2. **动态站点数量限制**
   - 根据VPS配置动态调整最大站点数量
   - 超过推荐数量时给出性能警告

3. **配置建议系统**
   - 为每个配置等级提供具体的使用建议
   - 低配置VPS建议使用单站点脚本

4. **安全检查**
   - 最低要求：512MB内存，5GB磁盘空间
   - 配置过低时拒绝继续部署

### 使用体验改进

```bash
=== VPS配置评估 ===
配置等级: 标准配置
最大站点数: 3 个
推荐站点数: 2 个

=== 配置建议 ===
⚠ 建议运行2-3个轻量级站点
⚠ 避免安装过多插件
✓ 必须启用缓存优化

请输入要部署的WordPress站点数量 (1-3): 
```

## deploy-single-wordpress.sh (单站点版) 新增功能

### VPS配置等级划分

| 配置等级 | 内存要求 | CPU要求 | 优化策略 | 适用场景 |
|----------|----------|---------|----------|----------|
| 高配置   | ≥4GB     | ≥2核    | 标准优化 | 高流量网站 |
| 中等配置 | ≥2GB     | ≥2核    | 积极优化 | 中等流量网站 |
| 标准配置 | ≥1GB     | ≥1核    | 激进优化 | 普通网站 |
| 小VPS配置| ≥512MB   | ≥1核    | 极限优化 | 轻量级网站 |
| 超小VPS  | ≥256MB   | ≥1核    | 生存模式 | 基础网站 |

### 小VPS专用优化

#### 1. 系统级优化
- **内核参数调整**：降低网络缓冲区大小
- **文件句柄限制**：从100万降低到10万
- **服务禁用**：禁用更多不必要的系统服务
- **Swap配置**：自动配置swap以缓解内存压力

#### 2. PHP优化
- **内存限制**：
  - 标准配置：512M
  - 小VPS：256M
  - 超小VPS：128M
- **进程池配置**：
  - 标准：每进程128MB
  - 小VPS：每进程64MB
  - 超小VPS：每进程32MB
- **OPcache优化**：
  - 标准：内存的1/4
  - 小VPS：内存的1/6
  - 超小VPS：内存的1/8

#### 3. MariaDB优化
- **内存分配**：
  - 标准：70%内存
  - 小VPS：50%内存
  - 超小VPS：40%内存
- **连接数限制**：
  - 标准：500连接
  - 小VPS：100连接
  - 超小VPS：50连接
- **缓冲区调整**：大幅降低各种缓冲区大小

#### 4. Redis优化
- **内存分配**：
  - 标准：15%内存
  - 小VPS：10%内存
  - 超小VPS：8%内存
- **连接限制**：
  - 标准：10000客户端
  - 小VPS：1000客户端
  - 超小VPS：500客户端

#### 5. WooCommerce智能警告
- **超小VPS**：强烈不建议安装，需要用户强制确认
- **小VPS**：给出使用建议和限制
- **标准配置以上**：正常支持

### 使用体验改进

```bash
=== VPS配置评估 (单站点极致性能版) ===
配置等级: 小VPS配置
优化策略: 极限优化

=== 配置建议 ===
⚠ 小VPS配置，将启用极限优化
⚠ 不建议使用WooCommerce
⚠ 建议使用轻量级主题和最少插件
✓ 启用所有节省资源的优化

=== 小VPS特别提醒 ===
您的VPS配置较低，脚本将自动应用以下优化：
  - 降低数据库内存使用
  - 减少PHP进程数
  - 启用更激进的缓存策略
  - 禁用不必要的功能
  - 优化系统参数以节省资源
```

## 技术实现细节

### 1. VPS配置检测
```bash
# 获取系统资源信息
local total_mem=$(free -m | awk '/^Mem:/{print $2}')
local cpu_cores=$(nproc)
local available_space=$(df / | awk 'NR==2 {print int($4/1024/1024)}')

# 根据内存和CPU确定VPS等级
if [[ $total_mem -ge 8192 && $cpu_cores -ge 4 ]]; then
    vps_tier="高配置"
    max_sites=10
elif [[ $total_mem -ge 4096 && $cpu_cores -ge 2 ]]; then
    vps_tier="中等配置"
    max_sites=6
# ... 更多等级判断
fi
```

### 2. 动态配置调整
```bash
# 根据VPS等级调整参数
if [[ "$VPS_TIER" == "小VPS配置" ]]; then
    php_memory_limit="256M"
    innodb_percent=50
    redis_percent=10
elif [[ "$VPS_TIER" == "超小VPS" ]]; then
    php_memory_limit="128M"
    innodb_percent=40
    redis_percent=8
fi
```

### 3. 智能警告系统
```bash
# 超过推荐数量时的警告
if [[ "$SITES_TO_DEPLOY" -gt "$RECOMMENDED_SITES" ]]; then
    echo -e "${YELLOW}[警告]${NC} 您选择的站点数量超过推荐数量"
    echo -e "这可能会影响网站性能，建议："
    echo -e "  - 使用轻量级主题"
    echo -e "  - 限制插件数量"
    # ... 更多建议
fi
```

## 用户受益

### 1. 防止VPS崩溃
- 自动检测配置，防止过度部署
- 智能限制站点数量
- 提供明确的配置建议

### 2. 优化资源利用
- 根据VPS配置自动调整参数
- 小VPS专用优化策略
- 最大化有限资源的利用效率

### 3. 改善用户体验
- 清晰的配置等级说明
- 具体的使用建议
- 智能的警告和确认机制

### 4. 提高部署成功率
- 避免因资源不足导致的部署失败
- 预防性能问题
- 提供适合的配置方案

## 配置对比表

### 多站点版本资源分配

| VPS等级 | MariaDB | Redis | PHP-FPM | 最大站点 |
|---------|---------|-------|---------|----------|
| 高配置  | 50%内存 | 10%内存 | 动态调整 | 10个 |
| 中等配置| 50%内存 | 10%内存 | 动态调整 | 6个  |
| 标准配置| 50%内存 | 10%内存 | 动态调整 | 3个  |
| 基础配置| 50%内存 | 10%内存 | 动态调整 | 2个  |
| 低配置  | 50%内存 | 10%内存 | 动态调整 | 1个  |

### 单站点版本资源分配

| VPS等级 | MariaDB | Redis | PHP-FPM | WooCommerce |
|---------|---------|-------|---------|-------------|
| 高配置  | 70%内存 | 15%内存 | 80%内存 | 完全支持 |
| 中等配置| 70%内存 | 15%内存 | 80%内存 | 支持 |
| 标准配置| 70%内存 | 15%内存 | 60%内存 | 谨慎使用 |
| 小VPS   | 50%内存 | 10%内存 | 60%内存 | 不推荐 |
| 超小VPS | 40%内存 | 8%内存  | 50%内存 | 强烈不推荐 |

## 总结

通过添加VPS配置要求限制功能，我们显著提高了脚本的智能化程度和用户体验：

1. **防止过度部署**：根据VPS配置智能限制站点数量
2. **优化资源配置**：为不同配置等级提供专门的优化策略
3. **改善用户体验**：提供清晰的建议和警告
4. **提高成功率**：避免因资源不足导致的部署失败

这些改进使得脚本更加适合各种配置的VPS，从高端服务器到小型VPS都能获得最佳的部署体验。